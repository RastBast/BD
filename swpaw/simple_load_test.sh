#!/bin/bash

# –ü—Ä–æ—Å—Ç–æ–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Verb Extractor API
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./simple_load_test.sh

set -e

API_URL="http://localhost:8080"
GREEN="\033[0;32m"
BLUE="\033[0;34m"
YELLOW="\033[1;33m"
RED="\033[0;31m"
NC="\033[0m" # No Color

echo -e "${GREEN}üß™ –ù–ê–ì–†–£–ó–û–ß–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï VERB EXTRACTOR API${NC}"
echo "=============================================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
echo -e "${YELLOW}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...${NC}"
if ! curl -s "$API_URL/api/health" >/dev/null 2>&1; then
    echo -e "${RED}‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: go run verb_extractor_server.go"
    exit 1
fi
echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
send_request() {
    local text="$1"
    local request_id="$2"

    start_time=$(date +%s%3N)
    response=$(curl -s -X POST "$API_URL/api/extract-verbs" \
        -H "Content-Type: application/json" \
        -d "{\"text\":\"$text\"}" 2>/dev/null)
    end_time=$(date +%s%3N)

    duration=$((end_time - start_time))

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
    if echo "$response" | jq -e '.verbs' >/dev/null 2>&1; then
        verb_count=$(echo "$response" | jq -r '.count' 2>/dev/null || echo "0")
        echo "$duration,$verb_count,success,$request_id"
    else
        echo "$duration,0,error,$request_id"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞
run_load_test() {
    local test_name="$1"
    local text="$2"
    local num_requests="$3"

    echo -e "\n${BLUE}üöÄ –¢–µ—Å—Ç: $test_name${NC}"
    echo "üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: $num_requests –∑–∞–ø—Ä–æ—Å–æ–≤"
    echo "üìù –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: ${#text} —Å–∏–º–≤–æ–ª–æ–≤"
    echo "----------------------------------------"

    # –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    temp_file=$(mktemp)

    echo "–ó–∞–ø—É—Å–∫ –∑–∞–ø—Ä–æ—Å–æ–≤..."
    start_test_time=$(date +%s%3N)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
    for i in $(seq 1 $num_requests); do
        send_request "$text" "$i" >> "$temp_file" &

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        if (( i % 10 == 0 )); then
            wait  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –≥—Ä—É–ø–ø—ã
            echo -n "."
        fi
    done
    wait  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    echo ""

    end_test_time=$(date +%s%3N)
    total_time=$((end_test_time - start_test_time))

    # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    total_requests=$(wc -l < "$temp_file")
    successful_requests=$(grep -c "success" "$temp_file" || echo "0")
    failed_requests=$(grep -c "error" "$temp_file" || echo "0")

    if [ $total_requests -gt 0 ]; then
        success_rate=$(( (successful_requests * 100) / total_requests ))
        rps=$(( (total_requests * 1000) / total_time ))

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞
        response_times=$(cut -d',' -f1 "$temp_file" | sort -n)
        min_time=$(echo "$response_times" | head -n1)
        max_time=$(echo "$response_times" | tail -n1)

        # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è (–ø—Ä–∏–º–µ—Ä–Ω–æ)
        sum_times=$(echo "$response_times" | awk '{sum += $1} END {print sum}')
        avg_time=$(( sum_times / total_requests ))

        # –ú–µ–¥–∏–∞–Ω–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
        median_line=$(( (total_requests + 1) / 2 ))
        median_time=$(echo "$response_times" | sed -n "${median_line}p")

        echo ""
        echo "üìà –†–ï–ó–£–õ–¨–¢–ê–¢–´:"
        echo "  ‚è±Ô∏è  –û–±—â–µ–µ –≤—Ä–µ–º—è: ${total_time}ms ($(( total_time / 1000 )).$(( (total_time % 1000) / 100 ))—Å)"
        echo "  üìä –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: $total_requests"
        echo "  ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö: $successful_requests ($success_rate%)"
        echo "  ‚ùå –ù–µ—É–¥–∞—á–Ω—ã—Ö: $failed_requests"
        echo "  üöÄ RPS: $rps –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫"
        echo ""
        echo "üìä –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞:"
        echo "  –°—Ä–µ–¥–Ω–µ–µ: ${avg_time}ms"
        echo "  –ú–µ–¥–∏–∞–Ω–∞: ${median_time}ms"
        echo "  –ú–∏–Ω–∏–º—É–º: ${min_time}ms"
        echo "  –ú–∞–∫—Å–∏–º—É–º: ${max_time}ms"

        # –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        echo ""
        echo "üí° –ê–Ω–∞–ª–∏–∑:"
        if [ $rps -gt 50 ]; then
            echo -e "  ${GREEN}üü¢ –•–æ—Ä–æ—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å${NC}"
        elif [ $rps -gt 20 ]; then
            echo -e "  ${YELLOW}üü° –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å${NC}"
        else
            echo -e "  ${RED}üî¥ –ù–∏–∑–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å${NC}"
        fi

        if [ $success_rate -ge 95 ]; then
            echo -e "  ${GREEN}üü¢ –í—ã—Å–æ–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å${NC}"
        elif [ $success_rate -ge 90 ]; then
            echo -e "  ${YELLOW}üü° –°—Ä–µ–¥–Ω—è—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å${NC}"
        else
            echo -e "  ${RED}üî¥ –ù–∏–∑–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å${NC}"
        fi
    else
        echo -e "${RED}‚ùå –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞${NC}"
    fi

    # –û—á–∏—Å—Ç–∫–∞
    rm -f "$temp_file"
}

# –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
echo -e "${YELLOW}üìã –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤...${NC}"

# –¢–µ—Å—Ç 1: –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
run_load_test "–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç" \
    "–Ø —á–∏—Ç–∞—é –∫–Ω–∏–≥—É –∏ –¥—É–º–∞—é –æ –∂–∏–∑–Ω–∏" \
    50

# –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
echo -e "\n‚è∏Ô∏è  –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã..."
sleep 2

# –¢–µ—Å—Ç 2: –°—Ä–µ–¥–Ω–∏–π —Ç–µ–∫—Å—Ç (–ì–ü–ú–†–ú)
run_load_test "–°—Ä–µ–¥–Ω–∏–π —Ç–µ–∫—Å—Ç (–ì–ü–ú–†–ú)" \
    "–ì–∞—Ä—Ä–∏ –∏–∑—É—á–∞–ª –Ω–∞—É–∫—É –∏ —á–∏—Ç–∞–ª –∫–Ω–∏–≥–∏. –û–Ω –¥—É–º–∞–ª –æ –º–∏—Ä–µ –∏ —Ö–æ—Ç–µ–ª –ø–æ–Ω—è—Ç—å –µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä —É—á–∏–ª –µ–≥–æ –ª–æ–≥–∏–∫–µ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º—É –º—ã—à–ª–µ–Ω–∏—é. –ú–∞–ª—å—á–∏–∫ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–æ–≤–æ–¥–∏–ª —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã." \
    30

# –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
echo -e "\n‚è∏Ô∏è  –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã..."
sleep 2

# –¢–µ—Å—Ç 3: –î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
run_load_test "–î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç" \
    "–°—Ç—É–¥–µ–Ω—Ç—ã –∏–∑—É—á–∞—é—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –ø—Ä–æ–µ–∫—Ç—ã. –û–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç –∫–æ–¥ –∏ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç –æ—à–∏–±–∫–∏. –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ –æ–±—ä—è—Å–Ω—è—é—Ç —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–∞–±–æ—Ç—ã. –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–∑–¥–∞—é—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. –ò–Ω–∂–µ–Ω–µ—Ä—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä—É—é—Ç —Å–∏—Å—Ç–µ–º—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å." \
    20

# –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
echo -e "\n‚è∏Ô∏è  –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã..."
sleep 2

# –¢–µ—Å—Ç 4: –ü—Ä–æ–±–ª–µ–º–∞ –∏–∑ –∑–∞–¥–∞–Ω–∏—è
run_load_test "–ü—Ä–æ–±–ª–µ–º–∞ –∏–∑ –∑–∞–¥–∞–Ω–∏—è (—Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—ã –≥–ª–∞–≥–æ–ª–∞)" \
    "–û–Ω —É–¥–∞—Ä–∏–ª –º—è—á. –ù—É–∂–Ω–æ —É–¥–∞—Ä–∏—Ç—å —Ç–æ—á–Ω–æ. –Ø —É–¥–∞—Ä—è—é –ø–æ —Ü–µ–ª–∏. –í—Å–µ —É–¥–∞—Ä–∏–ª–∏ –ø–æ –º–∏—à–µ–Ω–∏." \
    40

# –§–∏–Ω–∞–ª—å–Ω—ã–π –±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
echo -e "\n${YELLOW}‚ö° –ë–´–°–¢–†–´–ô –°–¢–†–ï–°–°-–¢–ï–°–¢${NC}"
echo "–û—Ç–ø—Ä–∞–≤–∫–∞ 100 –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤..."

stress_start=$(date +%s%3N)
success_count=0
for i in {1..100}; do
    if curl -s -X POST "$API_URL/api/extract-verbs" \
        -H "Content-Type: application/json" \
        -d '{"text":"–±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç"}' | jq -e '.verbs' >/dev/null 2>&1; then
        ((success_count++))
    fi

    if (( i % 20 == 0 )); then
        echo -n "."
    fi
done
echo ""
stress_end=$(date +%s%3N)
stress_duration=$((stress_end - stress_start))
stress_rps=$(( (100 * 1000) / stress_duration ))

echo "‚ö° –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
echo "  –í—Ä–µ–º—è: ${stress_duration}ms"
echo "  –£—Å–ø–µ—à–Ω—ã—Ö: $success_count/100"
echo "  RPS: $stress_rps –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫"

# –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo ""
echo "=============================================================="
echo -e "${GREEN}üéâ –ù–ê–ì–†–£–ó–û–ß–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û${NC}"
echo "=============================================================="

echo ""
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:"
echo "   ‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏–∏"
echo "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å connection pooling"
echo "   ‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è"
echo "   ‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ —Å–ª–æ–≤–∞—Ä—å –≥–ª–∞–≥–æ–ª–æ–≤"
echo "   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ä—É—Ç–∏–Ω—ã –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏"

echo ""
echo "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:"
echo "   ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API: $API_URL/"
echo "   ‚Ä¢ Health check: $API_URL/api/health"
echo "   ‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∏: $API_URL/api/metrics"
